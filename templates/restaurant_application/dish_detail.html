{% extends "base.html" %}

{% block title %}{{ dish.name }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <!-- –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                {% if dish.image %}
                    <img src="{{ dish.image.url }}" class="card-img-top" alt="{{ dish.name }}">
                {% else %}
                    <img src="https://via.placeholder.com/500x300" class="card-img-top" alt="–ù–µ–º–∞—î —Ñ–æ—Ç–æ">
                {% endif %}
            </div>
        </div>

        <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Å—Ç—Ä–∞–≤—É -->
        <div class="col-md-6">
            <h2 class="mb-1">{{ dish.name }}</h2>
            <p class="text-muted mb-3">{{ dish.category.name }}</p>
            <p><strong>–û–ø–∏—Å:</strong> {{ dish.description }}</p>
            <p><strong>–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏:</strong> {{ dish.ingredients }}</p>
            <p><strong>–¶—ñ–Ω–∞:</strong> <span class="text-success fw-bold">{{ dish.price }} –≥—Ä–Ω</span></p>

            {% if dish.average_rating %}
                <p><strong>–°–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥:</strong> ‚≠ê {{ dish.average_rating }}</p>
            {% else %}
                <p class="text-muted">–ü–æ–∫–∏ –Ω–µ–º–∞—î –æ—Ü—ñ–Ω–æ–∫</p>
            {% endif %}

            <div class="d-flex gap-2 my-3">
                {% if dish.available %}
                    <a href="{% url 'add_to_cart' dish.id %}" class="btn btn-success flex-fill">
                        üõí –î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫
                    </a>
                {% else %}
                    <button class="btn btn-secondary flex-fill" disabled>–ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</button>
                {% endif %}
                <a href="{% url 'menu' %}" class="btn btn-primary flex-fill">‚¨Ö –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –º–µ–Ω—é</a>
            </div>
        </div>
    </div>

    <hr class="my-5">

    <!-- –í—ñ–¥–≥—É–∫–∏ -->
    <div class="reviews">
        <h3 class="mb-4">–í—ñ–¥–≥—É–∫–∏</h3>

        {% for review in reviews %}
            <div class="card mb-3 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ review.user.username }}</strong>
                            <div>–û—Ü—ñ–Ω–∫–∞: ‚≠ê {{ review.rating }}</div>
                        </div>
                        <small class="text-muted">{{ review.created_at|date:"d.m.Y H:i" }}</small>
                    </div>
                    <p class="mt-2 mb-0">{{ review.comment }}</p>

                    {% if user.is_staff %}
                        <form method="post" action="{% url 'delete_review' review.id %}" class="mt-2" onsubmit="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—ñ–¥–≥—É–∫?');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>
                        </form>
                    {% endif %}
                </div>
            </div>
        {% empty %}
            <p class="text-muted">–í—ñ–¥–≥—É–∫—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î.</p>
        {% endfor %}
    </div>

    <hr class="my-5">

    <!-- –§–æ—Ä–º–∞ –≤—ñ–¥–≥—É–∫—É -->
    <div class="leave-review">
        <h4 class="mb-3">–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</h4>

        {% if user.is_authenticated %}
            <form method="post">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="comment" class="form-label">–í–∞—à –≤—ñ–¥–≥—É–∫:</label>
                    <textarea name="comment" id="comment" rows="3" class="form-control" required></textarea>
                </div>

                <!-- –†–µ–π—Ç–∏–Ω–≥ –∫–Ω–æ–ø–∫–∞–º–∏ -->
                <div class="mb-3">
                    <label class="form-label d-block">–û—Ü—ñ–Ω–∫–∞:</label>
                    <div class="rating-buttons">
                        {% for i in "12345" %}
                            <input type="radio" id="rate{{ i }}" name="rating" value="{{ i }}" required>
                            <label for="rate{{ i }}">{{ i }}</label>
                        {% endfor %}
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
            </form>
        {% else %}
            <p><a href="{% url 'login' %}">–£–≤—ñ–π–¥—ñ—Ç—å</a>, —â–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫.</p>
        {% endif %}
    </div>
</div>

<style>
.rating-buttons {
  display: inline-flex;
  gap: 0.4rem;
}

.rating-buttons input {
  display: none;
}

.rating-buttons label {
  padding: 0.5rem 0.9rem;
  border: 2px solid #ccc;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  user-select: none;
}

.rating-buttons label.active {
  border-color: gold;
  background-color: gold;
  color: #000;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const buttons = document.querySelectorAll(".rating-buttons label");
  let selectedIndex = -1; // –∑–±–µ—Ä–µ–∂–µ–Ω–∞ –æ—Ü—ñ–Ω–∫–∞ (—ñ–Ω–¥–µ–∫—Å)

  function highlight(upTo) {
    buttons.forEach((b, i) => {
      b.classList.toggle("active", i <= upTo);
    });
  }

  // hover
  buttons.forEach((btn, idx) => {
    btn.addEventListener("mouseenter", () => {
      highlight(idx);
    });
    btn.addEventListener("mouseleave", () => {
      highlight(selectedIndex);
    });
  });

  // –∫–ª—ñ–∫ ‚Äî —Ñ—ñ–∫—Å—É—î–º–æ –≤–∏–±—ñ—Ä
  buttons.forEach((btn, idx) => {
    btn.addEventListener("click", () => {
      selectedIndex = idx;
      highlight(idx);
      document.getElementById("rate" + (idx + 1)).checked = true;
    });
  });
});
</script>
{% endblock %}
